using System;
using HotChocolate.Data.SqlKata.Paging;
using HotChocolate.Types.Pagination;
using Microsoft.Extensions.DependencyInjection;

namespace HotChocolate.Types
{
    public static class MongoPagingObjectFieldDescriptorExtensions
    {
        /// <summary>
        /// Adds cursor pagination support to the field. Rewrites the type to a connection type and
        /// registers the mongo pagination handler
        /// </summary>
        /// <param name="descriptor">The descriptor of the field</param>
        /// <param name="options">The options for pagination</param>
        /// <typeparam name="TSchemaType">
        /// The schema type of the entity. Not a connection type
        /// </typeparam>
        /// <typeparam name="TEntity">The type of the entity</typeparam>
        /// <returns>The <paramref name="descriptor"/></returns>
        public static IObjectFieldDescriptor UseSqlKataPaging<TSchemaType, TEntity>(
            this IObjectFieldDescriptor descriptor,
            PagingOptions options = default)
            where TSchemaType : class, IOutputType =>
            UseSqlKataPaging<TSchemaType>(descriptor, typeof(TEntity), options);

        /// <summary>
        /// Adds cursor pagination support to the field. Rewrites the type to a connection type and
        /// registers the mongo pagination handler
        /// </summary>
        /// <param name="descriptor">The descriptor of the field</param>
        /// <param name="options">The options for pagination</param>
        /// <typeparam name="TSchemaType">
        /// The schema type of the entity. Not a connection type
        /// </typeparam>
        /// <returns>The <paramref name="descriptor"/></returns>
        public static IObjectFieldDescriptor UseSqlKataPaging<TSchemaType>(
            this IObjectFieldDescriptor descriptor,
            Type? entityType = null,
            PagingOptions options = default)
            where TSchemaType : class, IOutputType =>
            UseSqlKataPaging(descriptor, typeof(TSchemaType), entityType, options);

        /// <summary>
        /// Adds cursor pagination support to the field. Rewrites the type to a connection type and
        /// registers the mongo pagination handler
        /// </summary>
        /// <param name="descriptor">The descriptor of the field</param>
        /// <param name="type">
        /// The schema type of the entity. Not a connection type
        /// </param>
        /// <param name="entityType">The type of the entity</param>
        /// <param name="options">The options for pagination</param>
        /// <returns>The <paramref name="descriptor"/></returns>
        public static IObjectFieldDescriptor UseSqlKataPaging(
            this IObjectFieldDescriptor descriptor,
            Type? type = null,
            Type? entityType = null,
            PagingOptions options = default) =>
            descriptor.UsePaging(
                type,
                entityType,
                (services, sourceType) => services.GetService<SqlKataCursorPagingProvider>() ??
                    new SqlKataCursorPagingProvider(),
                options);

        /// <summary>
        /// Adds offset pagination support to the field. Rewrites the type to a connection type and
        /// registers the mongo pagination handler
        /// </summary>
        /// <param name="descriptor">The descriptor of the field</param>
        /// <param name="type">
        /// The schema type of the entity. Not a connection type
        /// </param>
        /// <param name="entityType">The type of the entity</param>
        /// <param name="options">The options for pagination</param>
        /// <returns>The <paramref name="descriptor"/></returns>
        public static IObjectFieldDescriptor UseSqlKataOffsetPaging(
            this IObjectFieldDescriptor descriptor,
            Type? type = null,
            Type? entityType = null,
            PagingOptions options = default) =>
            descriptor.UseOffsetPaging(
                type,
                entityType,
                (services, sourceType) => services.GetService<SqlKataOffsetPagingProvider>() ??
                    new SqlKataOffsetPagingProvider(),
                options);

        /// <summary>
        /// Adds offset pagination support to the field. Rewrites the type to a connection type and
        /// registers the mongo pagination handler
        /// </summary>
        /// <param name="descriptor">The descriptor of the field</param>
        /// <param name="entityType">The type of the entity</param>
        /// <param name="options">The options for pagination</param>
        /// <typeparam name="TSchemaType">
        /// The schema type of the entity. Not a connection type
        /// </typeparam>
        /// <returns>The <paramref name="descriptor"/></returns>
        public static IObjectFieldDescriptor UseSqlKataOffsetPaging<TSchemaType>(
            this IObjectFieldDescriptor descriptor,
            Type? entityType = null,
            PagingOptions options = default)
            where TSchemaType : IOutputType =>
            UseSqlKataOffsetPaging(
                descriptor,
                typeof(TSchemaType),
                entityType,
                options);

        /// <summary>
        /// Adds offset pagination support to the field. Rewrites the type to a connection type and
        /// registers the mongo pagination handler
        /// </summary>
        /// <param name="descriptor">The descriptor of the field</param>
        /// <param name="options">The options for pagination</param>
        /// <typeparam name="TSchemaType">
        /// The schema type of the entity. Not a connection type
        /// </typeparam>
        /// <typeparam name="TEntity">The type of the entity</typeparam>
        /// <returns>The <paramref name="descriptor"/></returns>
        public static IObjectFieldDescriptor UseSqlKataOffsetPaging<TSchemaType, TEntity>(
            this IObjectFieldDescriptor descriptor,
            PagingOptions options = default)
            where TSchemaType : class, IOutputType =>
            UseSqlKataOffsetPaging<TSchemaType>(descriptor, typeof(TEntity), options);
    }
}
