{"componentChunkName":"component---src-templates-blog-article-template-tsx","path":"/blog/2019/02/04/instrumentation-and-apollo-tracing","result":{"data":{"markdownRemark":{"excerpt":"Today we have released Hot Chocolate , containing one cool new feature,\nwe wanne talk about here, namely Apollo Tracing which is extremelyâ€¦","frontmatter":{"featuredImage":null,"path":"/blog/2019/02/04/instrumentation-and-apollo-tracing","title":"GraphQL .NET Instrumentation API and Apollo Tracing","tags":["hotchocolate","graphql","dotnet","aspnetcore","tracing"],"author":"Rafael Staib","authorImageUrl":"https://avatars0.githubusercontent.com/u/4325318?s=100&v=4","authorUrl":"https://github.com/rstaib","date":"February 04, 2019"},"html":"<p>Today we have released Hot Chocolate <code class=\"language-text\">0.7.0</code>, containing one cool new feature,\nwe wanne talk about here, namely <em>Apollo Tracing</em> which is extremely powerful in\nidentifing things like performance bottlenecks in our <em>GraphQL</em> <em>APIs</em> for\nexample. As a result, we had to enhance our general instrumentation layer, which\nwe all benefit from. For instance, now it's way easier to register a\n<em>DiagnosticObserver</em> and bring in your own tracing framework, respectively. In\nthis blog article we will focus on these two topics.</p>\n<h2 id=\"apollo-tracing\" style=\"position:relative;\"><a href=\"#apollo-tracing\" aria-label=\"apollo tracing permalink\" class=\"anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\" width=\"16\" height=\"16\"><path d=\"M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z\"/></svg></a>Apollo Tracing</h2>\n<p><em>Apollo Tracing</em> is a <a href=\"https://github.com/apollographql/apollo-tracing\">performance tracing specification</a> for <em>GraphQL</em> servers.\nIt's not part of the actual <em>GraphQL</em> <a href=\"https://facebook.github.io/graphql\">specification</a> itself, but there is a\ncommon agreement in the <em>GraphQL</em> community that this should be supported by\nall <em>GraphQL</em> servers.</p>\n<p>So, we decided to introduce built-in <em>Apollo Tracing</em> support with this version.\nIn order to enable <em>Apollo Tracing</em> we just need to provide our own instance of\n<code class=\"language-text\">QueryExecutionOptions</code> to the <code class=\"language-text\">AddGraphQL</code> extension method and set the\n<code class=\"language-text\">TracingPreference</code> option to either <code class=\"language-text\">TracingPreference.Always</code> or\n<code class=\"language-text\">TracingPreference.OnDemand</code>. The difference between these two options is\nwhether tracing should be enabled always which means for each request or on\ndemand which means per request. But for now, enough words, let's see how this\nwould look like in code.</p>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"23303631813510920000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied code example\"\n              data-toaster-duration=\"3500\"\n              onClick=\"copyToClipboard(`services.AddGraphQL(sp => Schema.Create(c =>\n{\n    // Here goes the schema definition which is omitted for brevity purpose\n}),\nnew QueryExecutionOptions\n{\n    TracingPreference = TracingPreference.Always\n});`, `23303631813510920000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"Copy\"\n              >\n                <svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">services<span class=\"token punctuation\">.</span><span class=\"token function\">AddGraphQL</span><span class=\"token punctuation\">(</span>sp <span class=\"token operator\">=></span> Schema<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">=></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Here goes the schema definition which is omitted for brevity purpose</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">QueryExecutionOptions</span>\n<span class=\"token punctuation\">{</span>\n    TracingPreference <span class=\"token operator\">=</span> TracingPreference<span class=\"token punctuation\">.</span>Always\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>There it is. Very simple and straightforward, right? For more information head\nover <a href=\"https://hotchocolate.io/docs/apollo-tracing\">here</a>. Now, let's jump over to\nthe next topic.</p>\n<h2 id=\"instrumentation-api\" style=\"position:relative;\"><a href=\"#instrumentation-api\" aria-label=\"instrumentation api permalink\" class=\"anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\" width=\"16\" height=\"16\"><path d=\"M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z\"/></svg></a>Instrumentation API</h2>\n<p>In this version we did some heavy lifting in form of refactorings regarding the\nquery execution pipeline. This really helped us enhancing the\n<em>Instrumentation</em> <em>API</em> which has been evolved in two ways. First, we increased\nthe amount of available diagnostic events for more fine-grained tracing\nscenarios. Second, we simplified the registering of <em>DiagnosticObservers</em> by\nusing <em>Dependancy Injection</em> infrastructure. In the next example we can see how\nto register a custom <em>DiagnosticObservers</em>.</p>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"46880144266649640000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied code example\"\n              data-toaster-duration=\"3500\"\n              onClick=\"copyToClipboard(`services.AddGraphQL(sp => Schema.Create(c =>\n{\n    // Here goes the schema definition which is omitted for brevity purpose\n}),\nbuilder =>\n{\n    return builder\n        .UseDefaultPipeline()\n        .AddDiagnosticObserver<CustomDiagnosticObserver>();\n});`, `46880144266649640000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"Copy\"\n              >\n                <svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">services<span class=\"token punctuation\">.</span><span class=\"token function\">AddGraphQL</span><span class=\"token punctuation\">(</span>sp <span class=\"token operator\">=></span> Schema<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">=></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Here goes the schema definition which is omitted for brevity purpose</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\nbuilder <span class=\"token operator\">=></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> builder\n        <span class=\"token punctuation\">.</span><span class=\"token function\">UseDefaultPipeline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddDiagnosticObserver</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CustomDiagnosticObserver<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>So far so good. Writing a custom <em>DiagnosticObservers</em> is not difficult. Let's\nsee how we could achieve this.</p>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"94788213866443340000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied code example\"\n              data-toaster-duration=\"3500\"\n              onClick=\"copyToClipboard(`using HotChocolate.Execution;\nusing Microsoft.Extensions.DiagnosticAdapter;\n\nnamespace CustomNamespace\n{\n    internal class CustomDiagnosticObserver\n        : IDiagnosticObserver\n    {\n        [DiagnosticName(&quot;HotChocolate.Execution.Query&quot;)]\n        public void QueryExecute()\n        {\n            // This method is required to enable recording &quot;Query.Start&quot; and\n            // &quot;Query.Stop&quot; diagnostic events. Do not write code in here.\n        }\n\n        [DiagnosticName(&quot;HotChocolate.Execution.Query.Start&quot;)]\n        public void BeginQueryExecute(IQueryContext context)\n        {\n            // Here goes your code to trace begin query execution events.\n        }\n\n        [DiagnosticName(&quot;HotChocolate.Execution.Query.Stop&quot;)]\n        public void EndQueryExecute(\n            IQueryContext context,\n            IExecutionResult result)\n        {\n            // Here goes your code to trace end query execution events.\n        }\n    }\n}`, `94788213866443340000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"Copy\"\n              >\n                <svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">HotChocolate<span class=\"token punctuation\">.</span>Execution</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span>DiagnosticAdapter</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">CustomNamespace</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomDiagnosticObserver</span>\n        <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IDiagnosticObserver</span></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">DiagnosticName</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"HotChocolate.Execution.Query\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">QueryExecute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// This method is required to enable recording \"Query.Start\" and</span>\n            <span class=\"token comment\">// \"Query.Stop\" diagnostic events. Do not write code in here.</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">DiagnosticName</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"HotChocolate.Execution.Query.Start\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">BeginQueryExecute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IQueryContext</span> context<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// Here goes your code to trace begin query execution events.</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">DiagnosticName</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"HotChocolate.Execution.Query.Stop\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">EndQueryExecute</span><span class=\"token punctuation\">(</span>\n            <span class=\"token class-name\">IQueryContext</span> context<span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">IExecutionResult</span> result<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// Here goes your code to trace end query execution events.</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the above example we showed you just a few diagnostic events. Head over\n<a href=\"https://hotchocolate.io/docs/instrumentation\">here</a> for a complete list of\ndiagnostic events.</p>\n<p>We hope you enjoyed reading and be welcome to let us know what you think about\nit in the comments section. Thank you!</p>","fields":{"readingTime":{"text":"3 min read"}}},"site":{"siteMetadata":{"siteUrl":"https://chillicream.com","author":"Chilli_Cream"}}},"pageContext":{}},"staticQueryHashes":["1014893094","2890364758","4218812017"]}